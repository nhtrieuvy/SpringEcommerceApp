<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <title>Lịch sử trạng thái đơn hàng - Quản trị hệ thống</title>
</head>
<body>
    <section th:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 th:text="'Lịch sử trạng thái đơn hàng #' + ${order.id}"></h2>
            <a th:href="@{/admin/orders}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
        
        <!-- Order Summary -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0">Thông tin đơn hàng</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Mã đơn hàng:</strong> #<span th:text="${order.id}"></span></p>
                        <p><strong>Ngày đặt:</strong> <span th:text="${#dates.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span></p>
                        <p><strong>Trạng thái hiện tại:</strong>
                            <span class="badge rounded-pill" 
                                  th:classappend="${
                                    order.status == 'PENDING' ? 'text-bg-secondary' : 
                                    order.status == 'PROCESSING' ? 'text-bg-primary' : 
                                    order.status == 'SHIPPING' ? 'text-bg-info' : 
                                    order.status == 'COMPLETED' ? 'text-bg-success' : 'text-bg-danger'
                                  }"
                                  th:text="${
                                    order.status == 'PENDING' ? 'Chờ xác nhận' : 
                                    order.status == 'PROCESSING' ? 'Đang xử lý' : 
                                    order.status == 'SHIPPING' ? 'Đang giao hàng' : 
                                    order.status == 'COMPLETED' ? 'Đã hoàn thành' : 'Đã hủy'
                                  }">
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Khách hàng:</strong> <span th:text="${order.user.fullname}"></span></p>
                        <p><strong>Email:</strong> <span th:text="${order.user.email}"></span></p>
                        <p><strong>Số điện thoại:</strong> <span th:text="${order.user.phone}"></span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Order Status History Timeline -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Lịch sử trạng thái</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    <div th:if="${#lists.isEmpty(history)}" class="alert alert-info">
                        Không có lịch sử trạng thái nào được ghi nhận.
                    </div>
                    
                    <div th:each="item, iter : ${history}" class="timeline-item">
                        <div class="timeline-badge" th:classappend="${
                            item.status == 'PENDING' ? 'bg-secondary' : 
                            item.status == 'PROCESSING' ? 'bg-primary' : 
                            item.status == 'SHIPPING' ? 'bg-info' : 
                            item.status == 'COMPLETED' ? 'bg-success' : 'bg-danger'
                        }">
                            <i class="fas" th:classappend="${
                                item.status == 'PENDING' ? 'fa-clock' : 
                                item.status == 'PROCESSING' ? 'fa-cog' : 
                                item.status == 'SHIPPING' ? 'fa-truck' : 
                                item.status == 'COMPLETED' ? 'fa-check' : 'fa-times'
                            }"></i>
                        </div>
                        <div class="timeline-panel">
                            <div class="timeline-heading">
                                <h6 class="timeline-title" th:text="${
                                    item.status == 'PENDING' ? 'Chờ xác nhận' : 
                                    item.status == 'PROCESSING' ? 'Đang xử lý' : 
                                    item.status == 'SHIPPING' ? 'Đang giao hàng' : 
                                    item.status == 'COMPLETED' ? 'Đã hoàn thành' : 'Đã hủy'
                                }"></h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar-alt"></i> 
                                    <span th:text="${#dates.format(item.createdAt, 'dd/MM/yyyy HH:mm')}"></span>
                                </small>
                            </div>
                            <div class="timeline-body">
                                <p th:if="${!#strings.isEmpty(item.note)}" th:text="${item.note}"></p>
                                <p th:if="${#strings.isEmpty(item.note)}" class="text-muted"><em>Không có ghi chú</em></p>
                                <small th:if="${item.createdBy != null}" class="text-muted">
                                    Thực hiện bởi: <span th:text="${item.createdBy.fullname}"></span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .timeline {
                position: relative;
                padding: 20px 0;
            }
            .timeline:before {
                content: '';
                position: absolute;
                top: 0;
                bottom: 0;
                left: 20px;
                width: 3px;
                background: #e9ecef;
            }
            .timeline-item {
                position: relative;
                margin-bottom: 30px;
            }
            .timeline-badge {
                position: absolute;
                left: 0;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                text-align: center;
                color: #fff;
                line-height: 40px;
            }
            .timeline-badge i {
                font-size: 1rem;
            }
            .timeline-panel {
                position: relative;
                margin-left: 60px;
                padding: 15px;
                border-radius: 5px;
                border: 1px solid #e9ecef;
                background: #fff;
            }
            .timeline-panel:before {
                content: '';
                position: absolute;
                top: 15px;
                left: -10px;
                width: 0;
                height: 0;
                border-top: 10px solid transparent;
                border-bottom: 10px solid transparent;
                border-right: 10px solid #e9ecef;
            }
            .timeline-heading {
                margin-bottom: 10px;
            }
            .timeline-title {
                margin: 0;
                font-weight: 600;
            }
        </style>
    </section>
</body>
</html>
